# **競馬AIにおける高精度予測のための特徴量エンジニアリング詳細報告書**

## **I. 競馬AIにおける特徴量設計の基礎と戦略**

### **A. 予測モデル構築のためのデータフレームワークと哲学**

高精度な競馬予測AIモデルを構築する際の根幹は、その特徴量設計の厳密性に存在する。競馬データは本質的に時系列データであり、特徴量設計の最大の戦略的課題は、未来の情報を誤って学習データに含めてしまう「データリーク」を絶対的に排除することである。

具体的には、特徴量の計算は、予測対象レースのスタート時刻（または、それ以前の予測実行時点）において入手可能な情報のみに基づいていなければならない。この時間軸の管理がモデルの汎用性と実用的な予測能力を担保する。

特徴量は、その性質に基づき、以下の4つの主要なクラスターに体系化される。

1. **静的（Static）**  
2. **動的（Dynamic）**  
3. **相対的（Relative）**  
4. **主観的定量化（Quantified Subjective）**

このモジュール化された設計哲学により、個々の特徴量の役割と計算パイプラインにおける位置づけが明確になり、メンテナンス性と拡張性が向上する。競走馬の能力を評価する際、生の走行タイムや着順などの絶対値データに依存するモデルは、トラックコンディションやペース展開といった外部ノイズと馬の真の実力を混同してしまう傾向がある。したがって、高性能なAIを構築する上では、絶対的な計測値から、外部変動を相殺し、競走馬の実力を浮き彫りにする相対的かつ動的な指標へと焦点を移すことが核となる \[1\]。

### **B. 特徴量前処理の必須要件**

特徴量設計の後には、機械学習モデルへの入力に適した形式に変換する厳密な前処理が必要となる。

* スケーリング処理  
  連続値特徴量、特にスピード指数や過去走タイムに関連する派生特徴量については、モデルの安定性と学習の収束速度を高めるために、標準化（Z-score）または正規化（Min-Max）が必須となる。これらのスケーリングは、勾配降下法をベースとするモデル（ニューラルネットワークなど）だけでなく、勾配ブースティングモデル（LightGBMやXGBoost）においても、特徴量の比較可能性を高める上で重要である。  
* 欠損値処理  
  過去走履歴を参照する特徴量では、未出走馬や長期休養明けの馬など、頻繁に欠損値が発生する。このような欠損に対しては、単なる平均値代入ではなく、ドメイン知識に基づいた戦略を採用する。  
  * 例：未出走馬の過去走平均着順には「クラス平均値」を代入、あるいはゼロ埋めを行う。  
  * **欠損フラグの活用**：同時にその特徴量が欠損していたことを示すバイナリの「欠損フラグ特徴量」を別途追加することで、モデルが欠損自体を情報として利用できるようにする。

### **C. データリークの防止策とバイアスの管理**

予測精度に強い影響を与える市場情報、特にオッズ特徴量を取り扱う際には、時間的整合性が不可欠である。オッズはレース結果を反映して変動するため、レース終了後に確定する最終オッズ（Post-Time Odds）を特徴量として使用することは、重大なデータリーク、すなわち未来情報への依存を引き起こす。

このため、特徴量として使用するオッズは、必ず**前日オッズまたはレース開始直前の確定前のオッズ**に限定しなければならない。オッズそのものに加え、フィールド内のオッズ順位（オッズランク）を特徴量として導入することも、市場の集合知が予測する期待値を捉える上で有効な手法となる。

## **II. 静的・基礎特徴量の詳細分析とエンコーディング**

### **A. 競走馬の物理的・属性情報**

馬齢、性別、斤量といった基本的な属性は、モデルのベースラインを形成する静的な特徴量である。

* **馬齢**: 3歳と4歳以上で成長曲線が大きく異なるため、カテゴリカル変数（例：3歳、4歳以上）と連続値（月齢換算）の両方として処理することで、非線形な影響を捉える。  
* **斤量**: そのまま連続値として入力するが、ハンデキャップレースにおいては、基準斤量からの差分を計算した「相対斤量」を派生特徴量として追加する。

静的特徴量の中で、特に予測への貢献度が高いのが**馬体重と馬体重増減**である \[2\]。これは輸送によるストレスや、調教による仕上げ度合いを反映する重要な指標となる。

馬体重増減の計算式:

$$Wt\_{change} \= Wt\_{Today} \- Wt\_{Previous}$$  
さらに、体重変動の安定性を評価するため、過去5走の馬体重増減の移動平均や分散、標準偏差も計算し、特徴量セットに組み込む。馬体重増減の非線形な影響を考慮し、増減をカテゴリ化（例：+10kg以上、±5kg以内、-10kg以下）した特徴量も導入される。

### **B. 血統データの活用と高度なエンコーディング手法**

血統情報は、競走馬の距離適性や芝・ダート適性の基礎を決定づける静的な情報でありながら、数千に及ぶカテゴリが存在するため、その複雑性から高度なエンコーディング手法が不可欠となる \[1, 2\]。

単純なOne-Hotエンコーディングでは、次元の呪いの問題やデータスパース性の問題が発生し、モデルの学習効率が低下する。そのため、以下の手法が推奨される。

* Target Encoding (Weight of Evidence: WoE)  
  特定のカテゴリ（例：特定の父馬）を、そのカテゴリに属する過去の産駒の成績（例：平均勝率や平均獲得賞金）の数値に置き換える手法。  
  注意点: 厳密な時間的分離（Out-of-Foldエンコーディング）を適用し、未来の成績に基づいてエンコードされることを防ぐ必要がある。  
* ニックスの定量化  
  特定の父馬と母父馬の組み合わせ（ニックス）が成功率に与える影響を定量化する。過去の同ニックス組み合わせの産駒成績を事前に集計し、勝率や平均ROIを算出し、スコアとして組み込む。

#### **\[表1\] 血統・コンビネーション特徴量の高度エンコーディング戦略**

| 特徴量カテゴリ | 特徴量例 | カーディナリティ | 推奨エンコーディング戦略 | リスク管理 |
| :---- | :---- | :---- | :---- | :---- |
| **血統 (基礎)** | 父馬名, 母父馬名 | 高 (数百〜千) | Target Encoding (Out-of-Fold), Embedding Layer | 時間的データリークの厳格な排除 |
| **血統 (派生)** | ニックス成功率スコア | 低〜中 | 標準化 (Standardization) | 過去の実績データの定期的な更新 |
| **連携実績** | 騎手-調教師コンビ勝率 | 中 | WoE (Weight of Evidence) | 特定条件（例：開催競馬場）での実績に絞り込む |

### **C. 騎手・調教師データ**

騎手や調教師の単体の実績だけでなく、特定の条件下でのコンビネーション実績を特徴量として導入することで、\*\*相乗効果（Synergy Feature）\*\*を捉えることが可能となる。 具体的には、特定の騎手と調教師のコンビが、過去の特定の競馬場、距離、馬場状態（芝/ダート）といった条件で達成した勝率、連対率、期待値（ROI）を算出し、それを特徴量として入力する。

## **III. 動的・相対的派生特徴量の計算と実装**

動的・相対的な派生特徴量は、AIモデルが競走馬の「現在のフォーム」と「フィールド内での優位性」を評価するために不可欠であり、予測優位性を生み出す鍵となるセクションである \[1, 3, 4\]。

### **A. スピード指数の精緻化と相対化 (Relative Speed Index \- RSI)**

絶対的な走破タイムは外部要因によって大きく変動するため、これらを考慮して調整された\*\*相対スピード指数（RSI）\*\*を開発することが必須である。

**RSI計算の基本概念:**

$$RSI \= \\frac{T\_{Bench} \- T\_{Horse}}{\\sigma\_{Track}} \\times C\_{Adjustment}$$

* $T\_{Bench}$: 当該レース条件（トラック、距離、馬場）における過去数年間の平均勝ちタイム  
* $T\_{Horse}$: 競走馬の過去最高の走破タイム  
* $\\sigma\_{Track}$: その基準タイムの標準偏差  
* $C\_{Adjustment}$: 当日の馬場状態やペース展開による補正係数

### **B. 過去走履歴特徴量の集約と時系列減衰**

直近のパフォーマンスに含まれる重要な「フォーム」のシグナルを希薄化させないため、直近のパフォーマンスを重視する時間減衰加重平均を適用する。

**時間減衰加重平均の式:**

$$P\_{Weighted} \= \\sum\_{i=1}^{N} P\_i \\times e^{-\\lambda t\_i}$$  
ここで、$P\_i$はパフォーマンス指標（着順、RSIなど）、$t\_i$は経過時間、$\\lambda$は減衰率（ハイパーパラメータ）である。

* **過去5走の平均着順 (APR)**: 競走馬の安定性を示す。  
* **過去10走の最高着順 (Max Finish Position)**: 潜在能力の天井を示す \[3\]。

### **C. フィールド相対特徴量 (Relative Field Metrics)**

競走馬の能力は、そのレースに出走する他の馬と比較されて初めて意味を持つ。

* **相対RSI (Relative RSI)**: 当該馬のRSI \- 出走フィールド全体のRSI平均値。  
* **フィールド内最高RSIとの差分**: 当該馬RSI \- フィールド内最高RSI。勝利に必要なギャップを示す。  
* **平均獲得賞金の相対順位**: フィールド内の全馬における獲得賞金のパーセンタイル順位。

#### **\[表2\] 主要な動的・相対的派生特徴量と計算式の概要 (Section III)**

| 特徴量名 | 略称 | 計算の目的 | 計算の基本概念 (Formula Outline) | 関連ソース |
| :---- | :---- | :---- | :---- | :---- |
| **相対スピード指数** | RSI | 外部要因を補正した走行能力の絶対評価 | (基準タイム \- 競走馬タイム) / 偏差 (補正済) | \[1, 4\] |
| **時間減衰平均RSI** | W\_RSI | 最新のフォームを重視した実力値 | 過去N走のRSIを指数減衰加重平均 | \[3\] |
| **フィールド内RSI偏差** | D\_RSI | フィールド内での相対的な優位性 | 当該馬RSI \- フィールド平均RSI | \[1\] |
| **競走馬クラス偏差** | CP\_D | 当該馬の過去のレースクラスと当レースクラスの差分 | 過去5走平均クラスレーティング \- 当レースクラスレーティング | \[3\] |

## **IV. 主観的情報の定量化とAIへの統合**

JRAデータ特有の専門家による主観的評価（パドック、追い切り）を、ノイズを抑えつつ数値化する手法である \[3, 4, 5\]。

### **A. 追い切りタイム (Training Time) の分析と特徴量化**

コースや負荷強度による多様性を管理するため、同条件における過去のパフォーマンスからの偏差を定量化する。

* **Oikiri\_Deviation\_Best**: 当該調教タイムが過去最高の同条件タイムからどの程度乖離しているかを示す。  
* **加速度特徴量**: 最終追い切りの時計が前週と比較してどの程度向上/悪化したか。  
* **相互作用**: 追い切りによる馬体重変化の度合いを統合し、意図的な仕上げを判断する。

### **B. パドック情報 (Paddock Data) の特徴量化**

専門家によるA〜Eなどの順序尺度を数値化する。

1. **順序エンコーディング**: A=5, B=4... のようにスコア化。  
2. **評価者中立化スコア (Rater-Neutralized Score)**: 評価者のバイアス（厳しさ）を補正するため、各評価者の平均スコアからの標準化偏差を使用する。  
3. **動的変化**: 直前レースのパドック評価と当日評価の差分（Paddock\_Score\_Change）により、調子の上向き/下向きを捉える \[5\]。

### **C. 専門紙指数およびオッズの統合**

* **専門紙指数**: そのままではなく、当日出走馬全体における **Z-Score（標準化得点）** に変換し、相対的優位性として扱う。  
* **オッズ**: 逆数（期待勝率）およびオッズ順位（パーセンタイルランク）として利用。

## **V. 機械学習モデルにおける特徴量重要度と最適化**

### **A. LightGBMおよびXGBoostモデルへの適応**

勾配ブースティングモデルにおいては、高カーディナリティのカテゴリ変数（血統など）は、事前にTarget Encodingされた連続値として扱う方が学習が安定する場合が多い。

### **B. 特徴量重要度ランキングの解析**

モデル構築後の分析（Feature Importance）において、トップティアの貢献度を示すのは、生データではなく派生特徴量である傾向が強い \[7\]。

#### **\[表3\] 高性能モデルにおける予測貢献度トップ10の特徴量（想定）**

| 順位 | 特徴量名 | カテゴリ | 想定SHAP値寄与率 (例) | 統計的意義 |
| :---- | :---- | :---- | :---- | :---- |
| 1 | **時間減衰相対スピード指数 (W\_RSI)** | 動的/相対 | 18% | 外部条件補正後の競走馬の基礎実力 |
| 2 | **馬体重増減 (正規化済)** | 静的 | 12% | 当日の調子の仕上げ度合い |
| 3 | **フィールド内オッズ順位** | 市場 | 10% | 集合知による期待値 |
| 4 | **騎手・調教師のトラック条件別コンビ勝率** | 連携 | 8% | 隠れた相乗効果と専門性 |
| 5 | **パドック評価 (バイアス補正済)** | 主観的定量化 | 6% | レース直前の馬体・気配の物理的評価 |
| 6 | **過去5走の最高上がりタイム相対偏差** | 動的 | 5% | 終盤の決定的な加速力 |

### **C. 多重共線性 (Multicollinearity) の管理と特徴量選択戦略**

相関性の高い特徴量が存在すると、重要度の解釈が困難になるため、SHAP値やパーミュテーション重要度を用いることが推奨される。  
高相関（$|Corr| \> 0.9$）の特徴量群に対する削減戦略：

1. 貢献度が低い方の特徴量を削除。  
2. **PCA** / **SVD**: 潜在変数を抽出して次元削減。  
3. **逐次特徴量選択 (SFS)**: 最小限の特徴量サブセットを決定する。

### **D. 特徴量の相互作用分析と非線形性の活用**

ドメイン知識に基づいた明示的な相互作用特徴量（例：枠順 × 距離適性、馬場状態 × 騎手実績）を作成することで、学習効率を飛躍的に向上させる。

## **VI. 結論と実装ロードマップ**

### **A. 最適な特徴量セット構築のための推奨事項**

JRAの競馬AI開発成功の鍵は、以下の3つの戦略的柱に支えられた派生特徴量の品質にある。

1. **相対性**: フィールド内での優位性の評価  
2. **時間減衰**: 最新フォームの正確な加重  
3. **主観データの定量化**: バイアス補正済みのパドック・追い切り情報

パイプライン全体での厳密な時系列管理（データリーク防止）が前提となる。

### **B. 今後のAI開発における特徴量エンジニアリングの展望**

今後の方向性は、**ディープラーニング技術による非構造化データの処理**にある。

* TransformerやRNN/LSTMを用いた血統やラップタイムの埋め込み（Embedding）。  
* 精緻化された特徴量を、強化学習エージェントの「状態表現」として統合し、ベッティング戦略全体の最適化を図る。

**参考文献 (References)**

* \[1\] Untitled, http://example-horse-details-2.com  
* \[2\] Untitled, http://example-foundational-23.com  
* \[3\] Untitled, http://example-jra-quantification-11.com  
* \[4\] Untitled, http://example-technical-22.com  
* \[5\] Untitled, http://example-jra-quantification-17.com  
* \[6\] Untitled, http://example-importance-16.com  
* \[7\] Untitled,