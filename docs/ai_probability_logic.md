# AIの予測確率と正規化に関する解説

このドキュメントでは、本競馬AIがどのように勝率を計算しているか、そしてなぜ最後に「正規化（合計100%にする処理）」が必要なのかを解説します。

## 1. AIの予測方式：各馬を「絶対評価」する

このAIは、出走馬全員を並べて「誰が一番速いか」を比較しているのではなく、**1頭ずつ個別に「この馬は勝てるレベルにあるか？」をテスト（採点）** しています。

*   **方式名**: 2値分類 (Binary Classification)
*   **イメージ**: 先生が生徒一人一人を個別に呼び出し、「君は東大に受かる実力があるか？」を判定している状態。

### なぜこの方式なのか？
競馬はレースによって「8頭立て」だったり「18頭立て」だったりと、参加人数（頭数）がバラバラだからです。
「最初から合計100%」にする方式（多クラス分類）は、常に選択肢の数が固定（例：A,B,Cの3択）でないと扱いづらいという技術的な制約があります。
1頭ずつ判定する今の方式なら、頭数が何頭になっても柔軟に対応できます。

## 2. なぜ確率の合計が100%にならないのか？

「1頭ずつの絶対評価」を行うため、以下のような現象が起こります。

### ケースA：ハイレベルな混戦
実力馬が多数揃ったレースでは、AIは複数の馬に対して「君も勝てる！」「君も勝てる！」と高い点数をつけます。
*   馬A：スコア 80点 (勝率80%)
*   馬B：スコア 70点 (勝率70%)
*   馬C：スコア 60点 (勝率60%)
*   **合計：210% (!!) -> これが「予測確率が高い」現象の正体です。**

### ケースB：低レベルなレース
決定打に欠ける弱い馬ばかりのレースでは、AIは全員に対して辛口評価をします。
*   馬A：スコア 20点
*   馬B：スコア 15点
*   ...
*   **合計：60% -> 誰も勝てなさそう（自信がない）状態。**

このように、**「合計値」はAIの「レース全体に対する自信度」を表している**とも言えます。

## 3. なぜ「正規化」が必要なのか？

AIが出したスコア（絶対評価）は正しいものですが、馬券を買う時の「オッズ（期待値）」計算は、**「このレースの勝者は必ず1人である（確率は合計100%）」** という前提ルールに基づいています。

そのため、AIの絶対評価を、競馬のルール（相対評価）に合わせて翻訳してあげる必要があります。これが**「正規化」**です。

### 計算イメージ（ハイレベル混戦の場合）
合計210%になってしまったスコアを、ギュッと圧縮して100%に収めます。

*   馬A (80%) -> **38%** に補正
*   馬B (70%) -> **33%** に補正
*   馬C (60%) -> **29%** に補正
*   **合計：100%**

### 正規化のメリット
1.  **買いすぎを防ぐ**: 合計210%のままだと、「期待値 > 1.0」の馬が大量発生し、あれもこれもと買いすぎてしまいます。正規化することで、本当に買うべき「他より優れた馬」だけが残ります。
2.  **シミュレーションと合う**: 過去のシミュレーション（弱気なモデル）でうまくいっていたロジックに合わせるため、現在の自信過剰気味なモデルの出力を適正範囲に補正する役割もあります。

## まとめ
*   **AI**: 「この馬は強い！」という**絶対的な強さ**を判定する担当。
*   **正規化**: その強さを「じゃあこのメンバーなら勝率は何%？」という**相対的な賭けの確率**に翻訳する担当。

この2段構えにすることで、どんな頭数のレースでも、またどんなレベルのレースでも、一貫した判断ができるようになっています。
