# 競馬AIプロジェクト状況報告書 (2025/12/08)

## 1. 現状の成果サマリー

本フェーズでは、モデルの堅牢性と収益性の向上を目的として、**時系列クロスバリデーション (TSCV)** と **LightGBM + CatBoost アンサンブル** の導入を行いました。

### 📊 モデル性能比較

| 指標 | Base (LightGBM Single) | **Advanced (Ensemble)** | 評価 |
|:---|:---:|:---:|:---|
| **Test AUC** | 0.7873 | **0.7892** | 微増だが確実に改善 |
| **LogLoss** | 0.2266 | **0.2263** | 予測確率の精度向上 |
| **ROI (2024)** | 53.3% | **68.1%** | :chart_with_upwards_trend: 苦手な年を大幅改善 |
| **ROI (2025 Sim)** | **100.4%** | 78.6% | 直近の爆発力はSingle優勢 |

### 🐎 実地検証結果 (2025/12/07 開催分)

シミュレーション上の数値だけでなく、実際のレースデータを用いた検証で決定的な差が確認されました。

| モデル | 投資対象 | 的中 | 回収率 | 備考 |
|:---:|:---:|:---:|:---:|:---|
| **Single** | 41レース | 0 | 0.0% | 全敗。穴馬を捉えきれず。 |
| **Ensemble** | 34レース | 1 | **66.5%** | **単勝22.6倍** (レーヴジーニアル) を的中 |

> [!IMPORTANT]
> **Ensemble採用の決め手**:
> Singleモデルが見落とした「15番人気・単勝22.6倍」の穴馬を、Ensembleモデルは的確に拾い上げました。
> 投資レース数を絞りつつ（41→34）、高配当を逃さない「守備力と攻撃力のバランス」が実証されました。

---

## 2. 実装された機能

### ✅ 技術的改善
- **Time Series Cross-Validation (TSCV)**: 未来のデータを学習に含ませない厳密な評価系を確立。
- **Hybrid Ensemble**:
    - **LightGBM**: 数値データや履歴データの扱いに長ける。
    - **CatBoost**: カテゴリ変数（血統・騎手IDなど）の扱いに長ける。
    - **Weighted Blending**: 両者の予測を最適比率（LGBM 4:6 CatBoost）で統合。
- **Target Encodingの適正化**: シミュレーションおよび当日予測において、リーケージのない正しいTarget Encodingパイプラインを構築。

### ✅ 運用スクリプトの刷新
- **`predict_today.py`**:
    - アンサンブルモデル対応完了。
    - 推奨しきい値を `EV > 2.3` に厳格化（シミュレーション最適値）。
    - 確率の人工的な正規化を廃止し、モデルの生確率を信頼するロジックへ変更。

---

## 3. 今後の進め方（推奨ロードマップ）

基盤モデルの性能は実用レベルに達しました。次は「運用の自動化」と「さらなるエッジの探求」がテーマになります。

### 🚀 Phase 3: 自動化と運用 (Next Priority)
1. **自動購入システムの構築**:
    - Selenium/Playwrightを用いたIPAT（JRA投票サイト）連携。
    - `predict_today.py` の出力を直接投票アクションに繋げる。
2. **LINE/Slack通知**:
    - 推奨馬が出たタイミングでスマホに通知を飛ばす。

### 🔬 Phase 4: さらなる精度向上 (Research)
1. **ペース・展開予測モデル**:
    - 「逃げ馬」の数や「ハイペース/スローペース」判定を特徴量に加える（未実装）。
2. **馬場状態のリアルタイム補正**:
    - 当日のクッション値や含水率をスクレイピングして特徴量に追加。
3. **騎手エージェント情報の活用**:
    - 騎手と調教師のコネクション情報の強化。

---

## 4. 結論

**「アンサンブルモデル + EV > 2.3」** の構成で運用を開始することを強く推奨します。
2025/12/07の検証結果が示す通り、この構成は大敗を防ぎつつホームランを狙える最もバランスの良い戦略です。
